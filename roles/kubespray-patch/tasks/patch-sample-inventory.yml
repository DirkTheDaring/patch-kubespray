- name: Patch loadbalancer_apiserver in sample inventory to allow dyanmic settings
  replace:
    path   : "{{ kubespray_git_folder }}/inventory/sample/group_vars/all/all.yml"
    regexp : "^# loadbalancer_apiserver:.*$"
#    replace: |-
#      loadbalancer_apiserver: {% raw %}"{{ {}|combine({'address': kubespray_loadbalancer_apiserver_address|d(omit),'port': kubespray_loadbalancer_apiserver_port|d(omit)}) }}"{% endraw %}
    replace: |-
      {% raw %}
      loadbalancer_apiserver:
        address: "{{ kubespray_loadbalancer_apiserver_address }}"
        port:    "{{ kubespray_loadbalancer_apiserver_port }}"
      {% endraw %}

- name: Add patch to git
  ansible.builtin.command:
    chdir: "{{ kubespray_git_folder }}"
    argv:
      - git
      - add
      - "{{ item }}"
  loop:
  - inventory/sample/group_vars/all/all.yml

- name: Commit patch
  ansible.builtin.command:
    chdir: "{{ kubespray_git_folder }}"
    argv:
      - git
      - commit
      - -m
      - |-
        allow loadbalancer_apiserver to be dynamically defined
